<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HR Recommendation Chatbot</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family: Arial, sans-serif; }
    body { background:#f0f2f6; height:100vh; display:flex; flex-direction:column; }
    .header { background:#1e90ff; color:#fff; padding:10px; text-align:center; box-shadow:0 2px 4px rgba(0,0,0,.1); }
    .container { display:flex; flex:1; overflow:hidden; }
    .sidebar { width:260px; background:#fff; padding:10px; box-shadow:2px 0 4px rgba(0,0,0,.1); overflow-y:auto; }
    .sidebar h3 { color:#1e90ff; margin-bottom:10px; }
    .sidebar select, .sidebar button, .sidebar input { width:100%; padding:6px; margin:6px 0; border-radius:6px; border:1px solid #ccc; }
    .sidebar button { cursor:pointer; }
    .status { font-size:12px; margin:6px 0 12px; color:#666 }
    .dot { display:inline-block; width:8px; height:8px; border-radius:50%; margin-right:6px; background:#aaa; vertical-align:middle; }
    details { border:1px solid #e5e7eb; border-radius:8px; padding:6px 8px; margin-top:8px; }
    details summary { cursor:pointer; font-weight:600; color:#1e90ff; }
    .main { flex:1; display:flex; flex-direction:column; padding:10px; }
    .chat-area { flex:1; overflow-y:auto; padding:10px; background:#fff; border-radius:10px; box-shadow:0 2px 4px rgba(0,0,0,.1); margin-bottom:10px; }
    .message { display:flex; align-items:flex-start; gap:8px; margin:6px 0; padding:10px; border-radius:10px; background:#f9f9f9; animation:fadeIn .3s; }
    .user-message { background:#e3f2fd; }
    .bot-message { background:#fff3e0; }
    .avatar { width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:16px; flex-shrink:0; }
    .user-message .avatar { background:#1e90ff; color:#fff; }
    .bot-message .avatar { background:#ff9800; color:#fff; }
    .input-area { display:flex; gap:10px; }
    .input-area input { flex:1; padding:10px; border:1px solid #ccc; border-radius:5px; }
    .input-area button { padding:10px 20px; background:#1e90ff; color:#fff; border:none; border-radius:5px; cursor:pointer; }
    .footer { background:#1e90ff; color:#fff; text-align:center; padding:10px; box-shadow:0 -2px 4px rgba(0,0,0,.1); }
    .spinner { border:4px solid #f3f3f3; border-top:4px solid #1e90ff; border-radius:50%; width:20px; height:20px; animation:spin 1s linear infinite; display:inline-block; }
    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
    @keyframes fadeIn { from{opacity:0} to{opacity:1} }
  </style>
</head>
<body>
  <div class="header">
    <h2>ü§ñ HR Recommendation Chatbot</h2>
    <p>Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi tr·ª£ l√Ω nh√¢n s·ª± th√¥ng minh!</p>
  </div>

  <div class="container">
    <div class="sidebar">
      <button onclick="saveLastRecommendation()">üíæ L∆∞u ƒë·ªÅ xu·∫•t hi·ªán t·∫°i</button>
      <input type="number" id="history-store-id" placeholder="Store ID">
      <button onclick="showHistory()">üìú L·ªãch s·ª≠ ƒë·ªÅ xu·∫•t theo Store</button>
      <div id="history-area" style="margin-top:8px;"></div>

      <h3>T√πy ch·ªçn</h3>
      <div class="status">
        <span id="status-dot" class="dot"></span>
        <span id="status-text">ƒêang ki·ªÉm tra k·∫øt n·ªëi‚Ä¶</span>
      </div>
      <p>API: <span style="color:#1e90ff;">Flask proxy ‚Üí FastAPI</span></p>

      <select id="session-select">
        <option value="session-1">session-1</option>
      </select>
      <button onclick="createNewSession()">T·∫°o session m·ªõi</button>
      <button onclick="deleteCurrentSession()">X√≥a session hi·ªán t·∫°i</button>
      <button onclick="refreshSessions(false)">L√†m m·ªõi session</button>

      <details>
        <summary>‚ûï ƒêƒÉng k√Ω c·ª≠a h√†ng m·ªõi</summary>
        <label for="reg_store_id">Store ID*</label>
        <input id="reg_store_id" type="number" placeholder="VD: 999" />
        <label for="reg_store_name">T√™n c·ª≠a h√†ng*</label>
        <input id="reg_store_name" type="text" placeholder="VD: Bkr 999 ABC" />
        <label for="reg_kpi">KPI 2024 (trung b√¨nh)</label>
        <input id="reg_kpi" type="number" step="0.01" placeholder="VD: 2.62 (tu·ª≥ ch·ªçn)" />
        <label for="reg_viol">Violations (trung b√¨nh)</label>
        <input id="reg_viol" type="number" step="1" placeholder="VD: 18 (tu·ª≥ ch·ªçn)" />
        <button onclick="registerStore()">ƒêƒÉng k√Ω</button>
      </details>

      <button onclick="showContact()">Li√™n h·ªá</button>
    </div>

    <div class="main">
      <div class="chat-area" id="chat-area"></div>
      <div class="input-area">
        <input type="text" id="chat-input" placeholder="Nh·∫≠p tin nh·∫Øn...">
        <button onclick="sendMessage()">G·ª≠i</button>
      </div>
    </div>
  </div>

  <div class="footer">
    ¬© 2025 AIC | Email: aicenter@doticom.com | Phone: +84 123 456 789
  </div>

  <script>
    // ====== State ======
    let currentSession = localStorage.getItem("hr_current_session") || "session-1";
    let lastEmployees = null;
    let lastMeta = null;

    const chatArea = document.getElementById("chat-area");
    const chatInput = document.getElementById("chat-input");
    const sessionSelect = document.getElementById("session-select");
    const statusDot = document.getElementById("status-dot");
    const statusText = document.getElementById("status-text");

    // ====== Utils ======
    function esc(str){ return (str||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }
    function api(path, opts = {}) {
      return fetch(path, { headers: { "Content-Type": "application/json" }, ...opts })
        .then(r => { if (!r.ok) throw new Error(r.status+" "+r.statusText); return r.json(); });
    }

    // Chu·∫©n ho√° c√¢u l·ªánh: s·ªë ‚Üí g·ª£i √Ω cho c·ª≠a h√†ng N, "show to√†n b·ªô" ‚Üí "show to√†n b·ªô nh√¢n s·ª±"
    function normalizeQuery(s){
      const t = (s||"").trim().toLowerCase();
      if (/^\d+$/.test(t)) return `g·ª£i √Ω cho c·ª≠a h√†ng ${t}`;
      if (/^(show|hi·ªÉn th·ªã)\s+(to√†n b·ªô|t·∫•t c·∫£|all)(\s+nh√¢n s·ª±)?$/.test(t)) return "show to√†n b·ªô nh√¢n s·ª±";
      return s;
    }

    function addMessage(role, htmlContent) {
      const wrap = document.createElement("div");
      wrap.classList.add("message", role === "user" ? "user-message" : "bot-message");

      const avatar = document.createElement("div");
      avatar.classList.add("avatar");
      avatar.textContent = role === "user" ? "üë§" : "ü§ñ";

      const content = document.createElement("div");
      content.style.flex = "1";
      content.innerHTML = htmlContent;

      wrap.appendChild(avatar);
      wrap.appendChild(content);
      chatArea.appendChild(wrap);
      chatArea.scrollTop = chatArea.scrollHeight;
      return wrap;
    }
    const addBotHTML = (html) => addMessage("bot", html);

    function renderEmployeesTable(employees, title = "Danh s√°ch nh√¢n s·ª±") {
      if (!Array.isArray(employees) || employees.length === 0)
        return `<div><strong>${title}:</strong> Kh√¥ng c√≥ d·ªØ li·ªáu.</div>`;

      const head = `
        <thead>
          <tr style="background:#1e90ff;color:#fff;">
            <th style="text-align:left;padding:6px 8px;">Store ID</th>
            <th style="text-align:left;padding:6px 8px;">Store</th>
            <th style="text-align:left;padding:6px 8px;">H·ªç t√™n</th>
            <th style="text-align:left;padding:6px 8px;">Role</th>
            <th style="text-align:right;padding:6px 8px;">KPI 2024</th>
            <th style="text-align:right;padding:6px 8px;">Violations</th>
            <th style="text-align:right;padding:6px 8px;">ƒêi·ªÉm t·ªïng</th>
            <th style="text-align:right;padding:6px 8px;">Th√¢m ni√™n (th√°ng)</th>
          </tr>
        </thead>`;
      const rows = employees.map(e => `
        <tr>
          <td style="padding:6px 8px;">${e.store_id ?? "-"}</td>
          <td style="padding:6px 8px;">${e.store_name ?? "-"}</td>
          <td style="padding:6px 8px;"><strong>${e.employee_name ?? "-"}</strong></td>
          <td style="padding:6px 8px;">${e.role ?? "-"}</td>
          <td style="padding:6px 8px;text-align:right;">${e.kpi_2024 ?? "-"}</td>
          <td style="padding:6px 8px;text-align:right;">${e.violations_total ?? "-"}</td>
          <td style="padding:6px 8px;text-align:right;">${e.overall_score ?? "-"}</td>
          <td style="padding:6px 8px;text-align:right;">${e.tenure_months ?? "-"}</td>
        </tr>`).join("");
      return `
        <div style="margin-bottom:8px;"><strong>${title}</strong> ‚Äî t·ªïng: ${employees.length}</div>
        <div style="overflow:auto;border:1px solid #eee;border-radius:8px;background:#fff7e6;">
          <table style="border-collapse:collapse;width:100%;font-size:14px;">
            ${head}
            <tbody>${rows}</tbody>
          </table>
        </div>`;
    }

    // Hi·ªÉn th·ªã l·∫°i t·ª´ l·ªãch s·ª≠ (h·ªó tr·ª£ JSON ho·∫∑c text)
    function renderStoredMessage(m) {
      if (m.role === "bot") {
        let obj = null;
        try { obj = JSON.parse(m.content); } catch (e) { /* kh√¥ng ph·∫£i JSON */ }
        const employees = obj?.employees || obj?.payload?.employees;
        if (Array.isArray(employees)) {
          const title = obj?.meta?.title || obj?.response || "Danh s√°ch nh√¢n s·ª±";
          addBotHTML(renderEmployeesTable(employees, title));
          return;
        }
        addMessage("bot", esc(obj?.response || m.content));
      } else {
        addMessage("user", esc(m.content));
      }
    }

    // ====== Chat ======
    function sendMessage() {
      const raw = chatInput.value.trim();
      if (!raw) return;

      const message = normalizeQuery(raw);
      addMessage("user", esc(raw));
      chatInput.value = "";

      const spinner = addBotHTML('<div class="spinner"></div> ƒêang x·ª≠ l√Ω...');

      api("/chat", { method:"POST", body: JSON.stringify({ message, session_id: currentSession }) })
        .then(data => {
          spinner.remove();
          const employees = data.employees || data.payload?.employees;
          if (Array.isArray(employees)) {
            lastEmployees = employees;
            lastMeta = { store_id: data.meta?.store_id, top: data.meta?.top, title: data.meta?.title || data.response };
            const title = lastMeta.title || "Danh s√°ch nh√¢n s·ª±";
            addBotHTML(renderEmployeesTable(employees, title));
          } else {
            lastEmployees = null;
            lastMeta = null;
            addMessage("bot", esc(data.response || "Kh√¥ng c√≥ ph·∫£n h·ªìi."));
          }
          refreshSessions(true); // c·∫≠p nh·∫≠t ti√™u ƒë·ªÅ session
        })
        .catch(err => { spinner.remove(); addMessage("bot", "‚ö†Ô∏è L·ªói: " + esc(err.message)); });
    }

    // ====== L∆∞u ƒë·ªÅ xu·∫•t hi·ªán t·∫°i ======
    function saveLastRecommendation() {
      if (!lastEmployees || !lastMeta?.store_id || !lastMeta?.top) {
        alert("Kh√¥ng c√≥ ƒë·ªÅ xu·∫•t n√†o ƒë·ªÉ l∆∞u.");
        return;
      }
      api("/recommendations/save", {
        method: "POST",
        body: JSON.stringify({
          store_id: lastMeta.store_id,
          top: lastMeta.top,
          exclude_same_store: true,
          employees: lastEmployees,
          source: "ui",
          request_text: `Session ${currentSession}`
        })
      })
      .then(() => addBotHTML("‚úÖ ƒê√£ l∆∞u ƒë·ªÅ xu·∫•t v√†o DB."))
      .catch(err => addBotHTML("‚ö†Ô∏è L·ªói khi l∆∞u ƒë·ªÅ xu·∫•t: " + esc(err.message)));
    }

    // ====== L·ªãch s·ª≠ ƒë·ªÅ xu·∫•t ======
    function showHistory() {
      const sid = parseInt(document.getElementById("history-store-id").value || "0", 10);
      if (!sid) { alert("Nh·∫≠p Store ID ƒë·ªÉ xem l·ªãch s·ª≠."); return; }
      api(`/recommendations/by_store/${sid}`)
        .then(list => {
          if (!Array.isArray(list) || list.length === 0) {
            document.getElementById("history-area").innerHTML = "<i>Kh√¥ng c√≥ l·ªãch s·ª≠.</i>";
            return;
          }
          const html = `
            <div style="margin-top:8px;">
              <b>L·ªãch s·ª≠ ƒë·ªÅ xu·∫•t cho store ${sid}</b>
              <ul style="margin-top:6px;">
              ${list.map(it => `
                <li>
                  #${it.id} ‚Ä¢ ${it.created_at} ‚Ä¢ source: ${esc(it.source)} ‚Ä¢ top=${it.top_n}
                  <button onclick="loadRecDetail(${it.id})">Xem</button>
                </li>`).join("")}
              </ul>
            </div>`;
          document.getElementById("history-area").innerHTML = html;
        })
        .catch(err => addBotHTML("‚ö†Ô∏è L·ªói khi t·∫£i l·ªãch s·ª≠: " + esc(err.message)));
    }

    function loadRecDetail(id) {
      api(`/recommendations/${id}`)
        .then(rec => {
          const employees = rec.payload?.employees || [];
          const title = `#${rec.id} ‚Äì Store ${rec.store_id} ‚Äì Top ${rec.top_n}`;
          addBotHTML(renderEmployeesTable(employees, title));
        })
        .catch(err => addBotHTML("‚ö†Ô∏è L·ªói khi t·∫£i chi ti·∫øt ƒë·ªÅ xu·∫•t: " + esc(err.message)));
    }

    // ====== ƒêƒÉng k√Ω c·ª≠a h√†ng m·ªõi ======
    async function registerStore() {
      const id = parseInt(document.getElementById('reg_store_id').value, 10);
      const name = (document.getElementById('reg_store_name').value || '').trim();
      const kpiVal = document.getElementById('reg_kpi').value;
      const violVal = document.getElementById('reg_viol').value;

      if (!id || !name) {
        alert("Vui l√≤ng nh·∫≠p Store ID v√† T√™n c·ª≠a h√†ng.");
        return;
      }

      const payload = { store_id: id, store_name: name };
      const kpi = parseFloat(kpiVal);
      const viol = parseFloat(violVal);
      if (!Number.isNaN(kpi)) payload.kpi24_mean = kpi;
      if (!Number.isNaN(viol)) payload.violations_mean = viol;

      try {
        const res = await api('/stores/register', { method:'POST', body: JSON.stringify(payload) });
        addMessage('bot', `‚úÖ ƒê√£ ƒëƒÉng k√Ω c·ª≠a h√†ng <b>${esc(name)}</b> (ID: <b>${id}</b>). B·∫°n c√≥ th·ªÉ g√µ: <i>g·ª£i √Ω cho c·ª≠a h√†ng ${id}</i>`);
        // reset form
        document.getElementById('reg_store_id').value = '';
        document.getElementById('reg_store_name').value = '';
        document.getElementById('reg_kpi').value = '';
        document.getElementById('reg_viol').value = '';
      } catch (e) {
        alert("Kh√¥ng ƒëƒÉng k√Ω ƒë∆∞·ª£c: " + e.message);
      }
    }

    // ====== Sessions ======
    function populateSessions(list) {
      sessionSelect.innerHTML = "";
      list.forEach(s => {
        const opt = document.createElement("option");
        opt.value = s.id; opt.textContent = s.title || s.id;
        if (s.id === currentSession) opt.selected = true;
        sessionSelect.appendChild(opt);
      });
    }

    function loadMessages(sessionId) {
      chatArea.innerHTML = "";
      api(`/sessions/${sessionId}/messages`)
        .then(res => { res.messages.forEach(renderStoredMessage); })
        .catch(() => addMessage("bot", "‚ö†Ô∏è Kh√¥ng t·∫£i ƒë∆∞·ª£c l·ªãch s·ª≠."));
    }

    async function refreshSessions(keepCurrent = true) {
      try {
        const list = await api("/sessions");
        if (!list.length) {
          const s = await api("/sessions", { method:"POST", body: JSON.stringify({}) });
          currentSession = s.id;
          localStorage.setItem("hr_current_session", currentSession);
          populateSessions([s]);
          return;
        }
        if (!list.find(x => x.id === currentSession)) {
          currentSession = list[0].id;
          localStorage.setItem("hr_current_session", currentSession);
        }
        populateSessions(list);
      } catch (e) { console.error(e); }
    }

    function createNewSession() {
      api("/sessions", { method:"POST", body: JSON.stringify({}) })
        .then(s => {
          currentSession = s.id;
          localStorage.setItem("hr_current_session", currentSession);
          refreshSessions();
          chatArea.innerHTML="";
          addMessage("bot", `üÜï ƒê√£ t·∫°o session m·ªõi: <b>${esc(s.id)}</b>`);
        })
        .catch(err => alert("Kh√¥ng t·∫°o ƒë∆∞·ª£c session: " + err.message));
    }

    function deleteCurrentSession() {
      if (!currentSession) return;
      if (!confirm("X√≥a session hi·ªán t·∫°i?")) return;
      api(`/sessions/${currentSession}`, { method:"DELETE" })
        .then(() => {
          addMessage("bot", `üóëÔ∏è ƒê√£ x√≥a session: <b>${esc(currentSession)}</b>`);
          currentSession = "";
          refreshSessions(false).then(() => {
            if (sessionSelect.options.length) {
              currentSession = sessionSelect.options[0].value;
              localStorage.setItem("hr_current_session", currentSession);
              loadMessages(currentSession);
            } else {
              createNewSession();
            }
          });
          chatArea.innerHTML="";
        })
        .catch(err => alert("Kh√¥ng x√≥a ƒë∆∞·ª£c session: " + err.message));
    }

    sessionSelect.addEventListener("change", e => {
      currentSession = e.target.value;
      localStorage.setItem("hr_current_session", currentSession);
      loadMessages(currentSession);
    });

    chatInput.addEventListener("keypress", e => { if (e.key === "Enter") sendMessage(); });

    // ====== Health indicator ======
    function updateHealth(ok, msg) {
      statusDot.style.background = ok ? "#16a34a" : "#ef4444";
      statusText.textContent = ok ? "Backend s·∫µn s√†ng" : ("M·∫•t k·∫øt n·ªëi: " + (msg||""));
    }
    function checkHealth() {
      fetch("/health").then(r => r.json())
        .then(j => updateHealth(!!j.ok, j.error || "" ))
        .catch(err => updateHealth(false, err.message));
    }

    // ====== boot ======
    (async function boot(){
      checkHealth();
      await refreshSessions(true);
      loadMessages(currentSession);
      setInterval(checkHealth, 15000);
    })();

    function showContact(){ alert("Li√™n h·ªá: aicenter@doticom.com | +84 123 456 789"); }
  </script>
</body>
</html>
